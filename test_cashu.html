<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashu test</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <div x-data="wallet">

    <h3>Mint Quote</h3>
    <input :disabled="!mintQuote.request" @click="$el.select()" x-model="mintQuote.request">
    <button :disabled="!mintQuote.request || invoiceCopied" @click="copyInvoice"
            x-text="invoiceCopied ? 'copied!' : 'copy invoice'"></button>
    <pre x-text="JSON.stringify(mintQuote, null, 2)"></pre>
    <input type="number" min="1" x-model="plannedTokenAmount">
    <button @click="updateQuote">update quote</button>

    <h3>Checked</h3>
    <pre x-text="JSON.stringify(checkedQuote, null, 2)"></pre>

    <h3>Proofs</h3>
    <label>
      Total amount:
      <input type="number" readonly x-model="totalAmount">
    </label>
    <pre x-text="JSON.stringify(proofs, null, 2)"></pre>
    <button @click="checkQuote">check mint quote</button>
    <button :disabled="!canMint" @click="mint">mint</button>



    <pre x-text="JSON.stringify(info, null, 2)"></pre>
    <button @click="updateInfo">update info</button>

    <div x-data="transaction">
      <div>
        <h3>Send</h3>
        <label>
          Total amount:<br>
          <input type="number" readonly x-model="totalAmount">
        </label>

        <br>

        <label>
          Send amount:<br>
          <input type="number" min="1" x-model="sendAmount">
        </label>

        <br>

        <label>
          Send Token:<br>
          <input :disabled="!sendToken" readonly @click="$el.select()" type="text" x-model="sendToken">
        </label>

        <br>

        <button @click="send">send</button>
      </div>

      <div>
        <h3>Receive</h3>
        <label>
          Receive Token:<br>
          <input type="text" x-model="receiveToken">
        </label>

        <br>

        <button @click="receive">receive</button>
      </div>
    </div>

  </div>

  <script type="module">
    import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/module.esm.js';
    import { CashuMint, CashuWallet, MintQuoteState, getEncodedToken } from 'https://esm.sh/@cashu/cashu-ts@1.1.0';

    function createWallet() {
      const mintUrl = 'http://localhost:3338';
      const mint = new CashuMint(mintUrl);

      Alpine.data('transaction', () => ({
        sendToken: '',
        receiveToken: '',
        sendAmount: '0',
        proofs: [],
        wallet: null,

        async init() {
          this.wallet = new CashuWallet(mint, { unit: 'sat' });
        },

        async send() {
          const sendAmount = parseInt(this.sendAmount, 10);
          const proofs = Alpine.store('proofs');

          const { send: sendProofs, returnChange: changeProofs } = await this.wallet.send(sendAmount, proofs);
          const encoded = getEncodedToken({
            token: [{ mint: mintUrl, proofs: sendProofs }]
          });
          Alpine.store('proofs', changeProofs);
          console.log('response', changeProofs, sendProofs, encoded);
        },

        async receive() {
          if (!this.receiveToken) return;
          const receive = await this.wallet.receive(this.receiveToken);
          if (receive) Alpine.store('proofs').push(...receive);
        }
      }));

      Alpine.data('wallet', () => ({
        plannedTokenAmount: '0',

        wallet: null,
        info: {},
        mintQuote: {},
        proofs: [],
        checkedQuote: {},
        invoiceCopied: false,

        get totalAmount() {
          return Alpine.store('proofs').reduce((total, proof) => total + proof.amount, 0);
        },

        get pendingAmount() {
          return Alpine.store('quotes')
            .filter(quote => quote.state === MintQuoteState.UNPAID)
            .reduce((total, quote) => total + quote.amount, 0);
        },

        get canMint() {
          const allowed = this.checkedQuote.state === MintQuoteState.PAID;
          return allowed;
        },

        async init() {
          this.wallet = new CashuWallet(mint, { unit: 'sat' });
        },

        async copyInvoice() {
          navigator.clipboard.writeText(this.mintQuote.request);
          this.invoiceCopied = true;
          setTimeout(() => (this.invoiceCopied = false), 3000);
        },

        async updateQuote() {
          const plannedTokenAmount = parseInt(this.plannedTokenAmount, 10);
          this.mintQuote = await this.wallet.createMintQuote(plannedTokenAmount);
          console.log('mint quote', this.mintQuote);
        },

        async updateInfo() {
          this.info = await this.wallet.getMintInfo();
        },

        async checkQuote() {
          if (!this.mintQuote.quote) return;
          this.checkedQuote = await this.wallet.checkMintQuote(this.mintQuote.quote);
          console.log('checked quote', this.checkedQuote);
        },

        async mint() {
          if (this.canMint) {
            const tokenAmount = parseInt(this.plannedTokenAmount, 10);
            const { proofs } = await this.wallet.mintTokens(tokenAmount, this.mintQuote.quote);
            const storedProofs = Alpine.store('proofs');
            storedProofs.push(...proofs);
            this.proofs = storedProofs;
            this.plannedTokenAmount = '0';
          }
        },
      }));

      Alpine.store('proofs', []);
      Alpine.store('quotes', []);
    }

    globalThis.addEventListener('alpine:init', () => {
      console.log('alpine init');
      createWallet();
    });

    Alpine.start();
  </script>
</body>

</html>